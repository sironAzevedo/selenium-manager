name: "Selenium Manager Healthcheck"
description: "Verifica /status, executa /start e /stop conforme necess√°rio"

inputs:
  base_url:
    description: "URL base do Selenium Manager (ex: http://localhost:9000)"
    required: true

runs:
  using: "composite"
  steps:

    - name: Ensure jq is installed
      shell: bash
      run: |
        if ! command -v jq &>/dev/null; then
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
        fi

    - name: Run Selenium health check workflow
      shell: bash
      run: |
        BASE_URL="${{ inputs.base_url }}"

        echo "üåê Selenium Manager URL: $BASE_URL"

        sleep 5

        # Fun√ß√£o auxiliar
        check_status() {
          RESPONSE=$(curl -s -w "\n%{http_code}" "$BASE_URL/status" || true)
          BODY=$(echo "$RESPONSE" | head -n1)
          CODE=$(echo "$RESPONSE" | tail -n1)

          echo "Status Code: $CODE"
          echo "Body: $BODY"

          if [ "$CODE" -ne 200 ]; then
            return 1
          fi

          echo "$BODY"
        }

        echo "üì° Verificando /status..."
        STATUS_RESPONSE=$(check_status)

        if [ $? -ne 0 ]; then
          echo "‚ùå /status n√£o retornou 200"
          exit 1
        fi

        OK_VALUE=$(echo "$STATUS_RESPONSE" | jq -r '.ok')

        if [ "$OK_VALUE" = "true" ]; then
          echo "üü¢ Selenium j√° est√° rodando"
        else
          echo "üü° Selenium n√£o est√° ativo, iniciando..."

          START_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BASE_URL/start")
          START_BODY=$(echo "$START_RESPONSE" | head -n1)
          START_CODE=$(echo "$START_RESPONSE" | tail -n1)

          echo "Start Code: $START_CODE"
          echo "Start Body: $START_BODY"

          if [ "$START_CODE" -ne 200 ]; then
            echo "‚ùå /start retornou erro"
            exit 1
          fi

          START_OK=$(echo "$START_BODY" | jq -r '.ok')
          if [ "$START_OK" != "true" ]; then
            echo "‚ùå /start retornou ok=false"
            exit 1
          fi
        fi

        echo "üõë Chamando /stop..."
        STOP_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BASE_URL/stop")
        STOP_BODY=$(echo "$STOP_RESPONSE" | head -n1)
        STOP_CODE=$(echo "$STOP_RESPONSE" | tail -n1)

        echo "Stop Code: $STOP_CODE"
        echo "Stop Body: $STOP_BODY"

        if [ "$STOP_CODE" -ne 200 ]; then
          echo "‚ùå /stop retornou erro"
          exit 1
        fi

        STOP_OK=$(echo "$STOP_BODY" | jq -r '.ok')
        if [ "$STOP_OK" != "true" ]; then
          echo "‚ùå /stop retornou ok=false"
          exit 1
        fi

        echo "üéâ Selenium Manager validado com sucesso!"
