name: selenium-manager-ci

on:
  push:
    branches-ignore:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services: {}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Build Docker image
        run: |
          docker build -t selenium-manager:ci .

      - name: Run container (detached)
        run: |
          # Run container mapping ports to runner
          docker run -d \
            --name selenium_ci \
            -p 4444:4444 \
            -p 7900:7900 \
            -p 9000:9000 \
            selenium-manager:ci

      - name: Wait for API to be available (timeout 120s)
        run: |
          echo "Waiting for control API at http://localhost:9000/status"
          for i in {1..24}; do
            if curl -sSf http://localhost:9000/status >/dev/null 2>&1; then
              echo "API up"
              break
            fi
            sleep 5
          done

      - name: Start Selenium inside container via control API
        run: |
          echo "Starting Selenium via API"
          curl -sS -X POST http://localhost:9000/start | jq -C . || true

      - name: Wait for Selenium readiness (timeout 180s)
        run: |
          echo "Waiting for Selenium readiness on http://localhost:4444/status"
          READY=false
          for i in {1..36}; do
            # Check container's /status endpoint — accept any 2xx or recognized running status
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4444/status || echo "000")
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              READY=true
              break
            fi
            # Fallback: try the control-selenium status
            if curl -sS http://localhost:9000/status | grep -q 'running'; then
              READY=true
              break
            fi
            sleep 5
          done
          if [ "$READY" = false ]; then
            echo "Selenium did not become ready in time"
            docker logs selenium_ci || true
            docker exec selenium_ci tail -n 200 /var/log/selenium.log || true
            exit 1
          fi

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install selenium

      - name: Run functional test
        env:
          SELENIUM_URL: http://localhost:4444/wd/hub
        run: |
          python3 testes/test_google.py

      - name: Collect container logs (always)
        if: always()
        run: |
          echo '== docker ps =='
          docker ps -a || true
          echo '== container logs ==' 
          docker logs selenium_ci || true
          echo '== selenium.log tail ==' 
          docker exec selenium_ci tail -n 200 /var/log/selenium.log || true

      - name: Cleanup container
        if: always()
        run: |
          docker rm -f selenium_ci || true  

  create_pr:
    runs-on: ubuntu-latest
    needs: [ build-and-test ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: 'Automatic PR: Merge changes to main'
          branch: ${{ github.ref }}
          base: main
          title: 'Automatic PR from ${{ github.ref }}'
          body: |
            Este PR foi criado automaticamente pelo fluxo de trabalho de CI para mesclar alterações de ${{ github.ref }} para main.